#!/usr/bin/env bash
set -euo pipefail

source "${0}-env"

export AWS_EC2_METADATA_DISABLED=true

if [ -z "${ENVIRONMENT:-}" ]; then
    export ENVIRONMENT=development
fi

echo 'Starting foxCaves init sequence...'
set -x

if [ -z "${FCV_STORAGE_ROOT:-}" ]; then
    export FCV_STORAGE_ROOT=/var/lib/foxcaves
fi

# Basic directory structure
mkdir -p "${FCV_STORAGE_ROOT}/storage"

# SSL setup
mkdir -p "${FCV_STORAGE_ROOT}/acme/storage"
"${FCV_OPENSSL}/bin/openssl" req -x509 -newkey rsa:2048 -keyout "${FCV_STORAGE_ROOT}/acme/snakeoil.key" -out "${FCV_STORAGE_ROOT}/acme/snakeoil.crt" -sha256 -days 3650 -nodes -subj '/CN=snakeoil' >/dev/null 2>/dev/null
if [ ! -f "${FCV_STORAGE_ROOT}/acme/account.key" ]; then
    "${FCV_OPENSSL}/bin/openssl" genpkey -algorithm RSA -pkeyopt rsa_keygen_bits:4096 -out "${FCV_STORAGE_ROOT}/acme/account.key" >/dev/null 2>/dev/null
fi

chmod 640 "${FCV_STORAGE_ROOT}/acme/account.key"
chmod 700 "${FCV_STORAGE_ROOT}/acme/storage"
# END SSL setup

if [ "$(id -u)" -eq '0' ]; then
    if [ ! -f /etc/passwd ]; then
        echo 'root:!x:::::::' > /etc/shadow
        echo 'foxcaves:!:::::::' >> /etc/shadow
        echo 'root:x:0:0::/root:' > /etc/passwd
        echo 'foxcaves:x:1000:1000::/var/lib/foxcaves:' >> /etc/passwd
        echo 'root:x:0:' > /etc/group
        echo 'foxcaves:x:1000:' >> /etc/group
        echo 'root:x::' > /etc/gshadow
        echo 'foxcaves:x::' >> /etc/gshadow
    fi

    chown foxcaves:foxcaves "${FCV_STORAGE_ROOT}/storage"
    chown foxcaves:foxcaves -R "${FCV_STORAGE_ROOT}/acme"

    mkdir -p /tmp
    chmod 2777 /tmp
fi

export FCV_NGINX_ROOT="$(mktemp -d)"
cp -r "${FCV_NGINX_TEMPLATE_ROOT}"/* "${FCV_NGINX_ROOT}"
chmod -R 755 "${FCV_NGINX_ROOT}"
"${FCV_LUAJIT}/bin/luajit" "${FCV_LUA_ROOT}/nginx_configure.lua"

mkdir -p "${FCV_NGINX_ROOT}/logs"
exec "${FCV_NGINX}/bin/openresty" -p "${FCV_NGINX_ROOT}" -c "${FCV_NGINX_ROOT}/main.conf" -e stderr -g 'user foxcaves;'
